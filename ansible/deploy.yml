---
- name: Deploy Flask application on server
  hosts: server
  become: yes
  vars:
    app_name: "app"
    app_user: "desauzzz"
    app_dir: "/home/adminstd/{{ app_name }}"
    git_repo: "https://github.com/DeSauzzz/DevOps.git"

  tasks:
    - name: Install programs which we need
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - git
          - postgresql
          - postgresql-contrib
        state: present

    - name: Create user for application
      user:
        name: "{{ app_user }}"
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Repository clone
      git:
        repo: "{{ git_repo }}"
        dest: "{{ app_dir }}"
        version: devel
        force: yes

    - name: Debug - Check repository structure
      find:
        paths: "{{ app_dir }}"
        patterns: "requirements.txt"
        recurse: yes
      register: find_result

    - name: Debug - Show found files
      debug:
        var: find_result.files

    - name: Create virtual environment
      command: python3 -m venv {{ app_dir }}/venv
      args:
        creates: "{{ app_dir }}/venv/bin/activate"

    - name: Install Python requirements
      pip:
        requirements: "{{ app_dir }}/myapp/requirements.txt"
        virtualenv: "{{ app_dir }}/venv"
        state: present

    - name: Create systemd service without .env
      copy:
        dest: /etc/systemd/system/{{ app_name }}.service
        content: |
          [Unit]
          Description=Flask Application
          After=network.target
          Wants=postgresql.service

          [Service]
          Type=simple
          User={{ app_user }}
          Group={{ app_user }}
          WorkingDirectory={{ app_dir }}/DevOps/myapp
          Environment="PATH={{ app_dir }}/venv/bin"
          Environment="FLASK_APP=app.py"
          Environment="FLASK_ENV=production"
          ExecStart={{ app_dir }}/venv/bin/gunicorn \
            --workers 3 \
            --bind 0.0.0.0:5000 \
            --access-logfile - \
            --error-logfile - \
            app:create_app()

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      when: true

    - name: Create systemd service with .env file
      copy:
        dest: /etc/systemd/system/{{ app_name }}.service
        content: |
          [Unit]
          Description=Flask Application
          After=network.target postgresql.service

          [Service]
          User={{ app_user }}
          Group={{ app_user }}
          WorkingDirectory={{ app_dir }}
          Environment="PATH={{ app_dir }}/venv/bin"
          EnvironmentFile={{ app_dir }}/.env
          ExecStart={{ app_dir }}/venv/bin/gunicorn \
            --workers 3 \
            --bind 0.0.0.0:5000 \
            --access-logfile - \
            --error-logfile - \
            app:create_app()

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      when: false

    - name: Restart systemd and start service
      systemd:
        name: "{{ app_name }}"
        state: restarted
        enabled: yes
        daemon_reload: yes

    - name: Проверяем доступность приложения
      uri:
        url: http://localhost:5000/health
        method: GET
        status_code: 200
        timeout: 10
      register: health_check
      until: health_check.status == 200
      retries: 10
      delay: 5
